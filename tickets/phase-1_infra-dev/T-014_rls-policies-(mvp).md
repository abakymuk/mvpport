# [T-014] RLS Policies (MVP)

## Обоснование

Без RLS пользователи могут видеть чужие данные. Row Level Security — базовый уровень безопасности для мультитенантных приложений.

## Область действия

### Входит в scope:

- ✅ Каждая таблица имеет org_id для изоляции данных
- ✅ Включить RLS в Supabase для всех таблиц
- ✅ Создать функцию is_member(org_id, role) для проверки доступа
- ✅ Написать политики: SELECT, INSERT, UPDATE по ролям

### Не входит в scope:

- Сложные многоуровневые разрешения
- Аудит доступа к данным
- Кэширование политик

## Задачи

### 1. Обновление схемы базы данных

**Требования:**

- Добавить org_id во все таблицы, где это необходимо
- Обеспечить ссылочную целостность
- Создать индексы для производительности

### 2. Включение RLS

**Требования:**

- Включить Row Level Security для всех таблиц
- Настроить базовые политики безопасности

**Команды:**

```sql
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.orgs ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.memberships ENABLE ROW LEVEL SECURITY;
```

### 3. Вспомогательные функции

**Требования:**

- Создать функцию is_member(org_id, role) для проверки доступа
- Создать функцию get_user_orgs() для получения доступных организаций
- Оптимизировать функции для производительности

### 4. RLS Политики

**Требования по ролям:**

- **VIEWER**: только чтение данных организации
- **MEMBER**: чтение + создание некоторых данных
- **ADMIN**: полный доступ к данным организации (кроме удаления org)
- **OWNER**: полный доступ ко всем данным организации

### 5. Тестирование безопасности

**Сценарии тестирования:**

- Пользователь без membership → не видит записи
- VIEWER → может читать, не может писать
- MEMBER → может читать и создавать
- ADMIN → может управлять данными
- OWNER → полный контроль

## Критерии приемки

- ✅ Пользователь A не видит данные организации B
- ✅ VIEWER не может писать данные
- ✅ OWNER может управлять всеми данными в своей org
- ✅ Все API endpoints работают с учетом RLS
- ✅ SQL тесты проходят успешно

## Качество

- ✅ Производительность запросов не ухудшена
- ✅ Все функции имеют комментарии
- ✅ Политики покрывают все операции CRUD
- ✅ Отсутствуют уязвимости в безопасности

## Ссылки и заметки

- [Supabase RLS Guide](https://supabase.com/docs/guides/auth/row-level-security)
- [PostgreSQL RLS Documentation](https://www.postgresql.org/docs/current/ddl-rowsecurity.html)
- [Multi-tenant Architecture Patterns](https://docs.microsoft.com/en-us/azure/sql-database/saas-tenancy-app-design-patterns)

## Статус выполнения

- ✅ Схема базы данных обновлена (добавлены @@map директивы)
- ✅ RLS включен для всех таблиц
- ✅ Созданы вспомогательные функции (is_member, is_owner, can_manage)
- ✅ Созданы RLS политики для всех операций CRUD
- ✅ Созданы тесты безопасности
- ✅ API endpoints обновлены для работы с RLS
- ✅ Создана документация по RLS

## Реализованные компоненты

### База данных

- **RLS Политики**: Полная изоляция данных между организациями
- **Вспомогательные функции**: is_member(), is_owner(), can_manage(), get_user_orgs()
- **Триггеры**: Автоматическое создание владельца, защита от удаления последнего владельца
- **Тесты**: Комплексные SQL тесты для проверки безопасности

### API Endpoints (с RLS)

- `GET /api/orgs` - получение организаций пользователя
- `POST /api/orgs` - создание организации
- `GET /api/orgs/[orgId]` - получение организации
- `PATCH /api/orgs/[orgId]` - обновление организации (только владельцы)
- `POST /api/orgs/[orgId]/members` - приглашение участников (админы/владельцы)
- `GET /api/profile` - получение профиля пользователя
- `PATCH /api/profile` - обновление профиля

### Утилиты

- **PrismaClientWithRLS**: Клиент с автоматической установкой RLS контекста
- **OrgService**: Сервис для работы с организациями
- **ProfileService**: Сервис для работы с профилями
- **withRLS**: Middleware для API handlers

### Документация

- **RLS Guide**: Полное руководство по Row Level Security
- **SQL файлы**: rls-policies.sql, rls-tests.sql
