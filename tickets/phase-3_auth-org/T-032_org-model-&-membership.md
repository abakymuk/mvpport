# [T-032] Org model & membership (RBAC + –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –æ—Ä–≥)

## üéØ –¶–µ–ª—å

–ú—É–ª—å—Ç–∏-—Ç–µ–Ω–∞–Ω—Ç–Ω–æ—Å—Ç—å ‚Äî –æ—Å–Ω–æ–≤–∞ B2B. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–æ—Å—Ç–æ—è—Ç—å –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è—Ö, —Ä–æ–ª–∏ –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç –¥–æ—Å—Ç—É–ø.

## üìã Scope (–≤—Ö–æ–¥–∏—Ç)

### ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

- [x] –¢–∞–±–ª–∏—Ü—ã: orgs, memberships (–µ—Å—Ç—å –≤ Prisma –±–∞–∑–∏—Å)
- [x] –†–æ–ª–∏: OWNER, ADMIN, MEMBER, VIEWER
- [x] –ë–∞–∑–æ–≤—ã–µ API endpoints –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π
- [x] RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### üîÑ –¢—Ä–µ–±—É–µ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

- [ ] –ö–æ–Ω—Ç–µ–∫—Å—Ç —Ç–µ–∫—É—â–µ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏: —Ö—Ä–∞–Ω–µ–Ω–∏–µ active_org_id —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- [ ] UI –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π –≤ —Å–∞–π–¥–±–∞—Ä–µ
- [ ] –°–µ—Ä–≤–µ—Ä–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º
- [ ] –°—Ç—Ä–∞–Ω–∏—Ü—ã: /settings/organization, /members
- [ ] –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π

## üö´ Out of scope

- –¢—Ä–∞–Ω—Å—Ñ–µ—Ä –≤–ª–∞–¥–µ–Ω–∏—è –∏ –∞—Ä—Ö–∏–≤/—É–¥–∞–ª–µ–Ω–∏–µ org (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ)
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ç–∞—Ä–∏—Ñ–∞ –ø–æ –∫–æ–ª-–≤—É org (–¥–ª—è –±–∏–ª–ª–∏–Ω–≥–∞ –ø–æ–∑–∂–µ)

## üìù Tasks

### 1. Prisma –º–æ–¥–µ–ª–∏

- [x] –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –º–æ–¥–µ–ª–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Å—Ö–µ–º–µ
- [x] –ú–∏–≥—Ä–∞—Ü–∏–∏ + —Å–∏–¥ –¥–µ–º–æ‚Äë–¥–∞–Ω–Ω—ã—Ö
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ active_org_id –≤ –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### 2. –ö–æ–Ω—Ç–µ–∫—Å—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏

- [ ] –°–æ–∑–¥–∞—Ç—å lib/org.ts —Å —Ñ—É–Ω–∫—Ü–∏—è–º–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–µ–π
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å getActiveOrgId –∏ setActiveOrgId
- [ ] –î–æ–±–∞–≤–∏—Ç—å middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —á–ª–µ–Ω—Å—Ç–≤–∞

### 3. UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

- [ ] –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π –≤ —Å–∞–π–¥–±–∞—Ä–µ
- [ ] –°—Ç—Ä–∞–Ω–∏—Ü–∞ /settings/organization
- [ ] –°—Ç—Ä–∞–Ω–∏—Ü–∞ /members —Å —Ç–∞–±–ª–∏—Ü–µ–π —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- [ ] –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏

### 4. –°–µ—Ä–≤–µ—Ä–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

- [ ] –°–æ–∑–¥–∞—Ç—å lib/access.ts —Å —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞
- [ ] –î–æ–±–∞–≤–∏—Ç—å assertMember —Ñ—É–Ω–∫—Ü–∏—é
- [ ] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ API endpoints

## ‚úÖ Acceptance Criteria

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

- [x] –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π –∏ —á–ª–µ–Ω—Å—Ç–≤–∞
- [x] RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö

### –¢—Ä–µ–±—É–µ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

- [ ] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é org, —Å—Ç–∞—Ç—å –µ—ë OWNER
- [ ] –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç—å —Ç–µ–∫—É—â—É—é org —á–µ—Ä–µ–∑ —Å–∞–π–¥–±–∞—Ä; –≤—ã–±—Ä–∞–Ω–Ω–∞—è org —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –≤—Ö–æ–¥–µ
- [ ] –°—Ç—Ä–∞–Ω–∏—Ü–∞ Members –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏ –∏—Ö —Ä–æ–ª–∏ (read‚Äëonly, –¥–æ –∏–Ω–≤–∞–π—Ç–æ–≤)
- [ ] –õ—é–±–æ–π API —Ç—Ä–µ–±—É–µ—Ç org_id –∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî —á–ª–µ–Ω —ç—Ç–æ–π org

## ‚ö†Ô∏è Risks & Mitigations

### –†–µ—à–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

- [x] RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
- [x] –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º

### –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —Ä–∏—Å–∫–∏

- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Å RLS ‚Üí –æ—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –∞ RLS ‚Äî –∫–∞–∫ ¬´–ø–æ—Å–ª–µ–¥–Ω—é—é –ª–∏–Ω–∏—é –æ–±–æ—Ä–æ–Ω—ã¬ª
- –û—à–∏–±–∫–∏ —Å ¬´–∞–∫—Ç–∏–≤–Ω–æ–π org¬ª (—Ç–µ—Ä—è–µ—Ç—Å—è) ‚Üí —Ö—Ä–∞–Ω–∏—Ç—å –≤ –ø—Ä–æ—Ñ–∏–ª–µ –∏ –≤ cookie/URL (?org=...) –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç

## üìö Notes/Links

- –°–æ–≤–º–µ—Å—Ç–∏–º–æ —Å T‚Äë014 (RLS)
- [Supabase RLS Documentation](https://supabase.com/docs/guides/auth/row-level-security)

## üîß –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

```sql
-- –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
CREATE TABLE public.orgs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  owner_id UUID NOT NULL REFERENCES auth.users(id),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- –ß–ª–µ–Ω—Å—Ç–≤–æ –≤ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è—Ö
CREATE TABLE public.memberships (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id),
  org_id UUID NOT NULL REFERENCES public.orgs(id),
  role TEXT NOT NULL DEFAULT 'MEMBER' CHECK (role IN ('OWNER', 'ADMIN', 'MEMBER', 'VIEWER')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(user_id, org_id)
);
```

### API Endpoints

- `GET /api/orgs` - —Å–ø–∏—Å–æ–∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `GET /api/orgs/[orgId]` - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
- `PATCH /api/orgs/[orgId]` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
- `GET /api/orgs/[orgId]/members` - —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- `POST /api/orgs/[orgId]/members` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞

### RLS –ü–æ–ª–∏—Ç–∏–∫–∏

- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏, –≤ –∫–æ—Ç–æ—Ä—ã—Ö —Å–æ—Å—Ç–æ—è—Ç
- –í–ª–∞–¥–µ–ª—å—Ü—ã –º–æ–≥—É—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–µ–π
- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### 1. –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ active_org_id –≤ –ø—Ä–æ—Ñ–∏–ª—å

```sql
ALTER TABLE public.profiles ADD COLUMN active_org_id UUID REFERENCES public.orgs(id);
```

### 2. –°–æ–∑–¥–∞—Ç—å lib/org.ts

```typescript
export async function getActiveOrgId(userId: string) {
  // –ß—Ç–µ–Ω–∏–µ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –∏–ª–∏ –ø–µ—Ä–≤–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
}

export async function setActiveOrgId(userId: string, orgId: string) {
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
}
```

### 3. –°–æ–∑–¥–∞—Ç—å lib/access.ts

```typescript
export async function assertMember(
  orgId: string,
  minRole: 'VIEWER' | 'MEMBER' | 'ADMIN' | 'OWNER'
) {
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–ª–µ–Ω—Å—Ç–≤–∞ –∏ —Ä–æ–ª–∏
}
```

### 4. UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π –≤ —Å–∞–π–¥–±–∞—Ä–µ
- –°—Ç—Ä–∞–Ω–∏—Ü—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–µ–π
- –¢–∞–±–ª–∏—Ü–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤

## üéØ –°—Ç–∞—Ç—É—Å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

- ‚úÖ **–ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö**: –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
- ‚úÖ **RLS –ø–æ–ª–∏—Ç–∏–∫–∏**: –ù–∞—Å—Ç—Ä–æ–µ–Ω–æ
- ‚úÖ **API endpoints**: –ë–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –≥–æ—Ç–æ–≤–∞
- üîÑ **UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**: –¢—Ä–µ–±—É–µ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
- üîÑ **–ö–æ–Ω—Ç–µ–∫—Å—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏**: –¢—Ä–µ–±—É–µ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
- üîÑ **–°–µ—Ä–≤–µ—Ä–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏**: –¢—Ä–µ–±—É–µ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
