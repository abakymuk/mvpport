# Добавление уникальности названий организаций

## Проблема с дубликатами

Если в базе данных уже есть организации с одинаковыми названиями, сначала нужно их исправить.

## Решение

### 1. Исправление дублирующихся названий

Выполните один из SQL скриптов в Supabase Dashboard:

**Вариант 1 (рекомендуемый):**

```sql
-- Файл: supabase/fix-duplicate-org-names.sql
-- Автоматически добавляет номера к дублирующимся названиям
```

**Вариант 2 (упрощенный):**

```sql
-- Файл: supabase/fix-duplicate-org-names-simple.sql
-- Добавляет ID к дублирующимся названиям
```

### 2. Создание уникального индекса

После исправления дубликатов выполните:

```sql
CREATE UNIQUE INDEX IF NOT EXISTS orgs_name_unique ON public.orgs (name);
```

## Что было добавлено

### 1. Уникальный индекс в базе данных

Предотвращает создание организаций с одинаковыми названиями.

### 2. Проверка в коде

- **В `lib/org.ts`**: Добавлена проверка существования организации с таким названием перед созданием
- **В `app/api/orgs/route.ts`**: Добавлена валидация длины названия и улучшена обработка ошибок
- **В `components/dashboard/org-switcher.tsx`**: Улучшено отображение ошибок дублирования

## Функциональность

### Валидация названий организаций:

- ✅ **Минимум 2 символа** - название не может быть слишком коротким
- ✅ **Максимум 100 символов** - название не может быть слишком длинным
- ✅ **Уникальность** - нельзя создать две организации с одинаковым названием
- ✅ **Пробелы** - автоматически удаляются лишние пробелы в начале и конце

### Обработка ошибок:

- **409 Conflict** - когда организация с таким названием уже существует
- **400 Bad Request** - когда название слишком короткое или длинное
- **Понятные сообщения** - пользователь видит четкие объяснения ошибок

## Применение изменений

1. **Выполните скрипт исправления дубликатов** в Supabase Dashboard
2. **Создайте уникальный индекс** (если еще не создан)
3. **Перезапустите сервер** разработки
4. **Протестируйте** создание организаций с одинаковыми названиями

## Альтернативные варианты

Если хотите разрешить одинаковые названия для разных владельцев, используйте:

```sql
-- Уникальность в рамках одного владельца
CREATE UNIQUE INDEX IF NOT EXISTS orgs_owner_name_unique ON public.orgs (owner_id, name);
```

Вместо:

```sql
-- Глобальная уникальность
CREATE UNIQUE INDEX IF NOT EXISTS orgs_name_unique ON public.orgs (name);
```
