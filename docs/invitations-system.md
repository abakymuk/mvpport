# Система приглашений в организации

## Обзор

Система приглашений позволяет администраторам и владельцам организаций приглашать новых участников по email. Приглашения имеют ограниченный срок действия и могут быть отозваны или повторно отправлены.

## Архитектура

### База данных

#### Таблица `invites`

```sql
CREATE TABLE public.invites (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id uuid NOT NULL REFERENCES public.orgs(id) ON DELETE CASCADE,
  email text NOT NULL,
  role text NOT NULL DEFAULT 'MEMBER' CHECK (role IN ('MEMBER', 'ADMIN', 'VIEWER')),
  status text NOT NULL DEFAULT 'PENDING' CHECK (status IN ('PENDING', 'ACCEPTED', 'DECLINED', 'EXPIRED')),
  token text NOT NULL UNIQUE,
  expires_at timestamptz NOT NULL DEFAULT (now() + interval '7 days'),
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now(),
  UNIQUE(org_id, email)
);
```

#### RLS политики

- **SELECT**: Только ADMIN+ могут читать приглашения своей организации
- **INSERT**: Только ADMIN+ могут создавать приглашения
- **UPDATE**: Только ADMIN+ могут обновлять приглашения (для отзыва)
- **DELETE**: Только ADMIN+ могут удалять приглашения

### API эндпоинты

#### `POST /api/invites`

Создание нового приглашения

**Тело запроса:**

```json
{
  "orgId": "uuid",
  "email": "user@example.com",
  "role": "MEMBER" // или "ADMIN", "VIEWER"
}
```

**Ответ:**

```json
{
  "id": "uuid",
  "org_id": "uuid",
  "email": "user@example.com",
  "role": "MEMBER",
  "status": "PENDING",
  "token": "unique-token",
  "expires_at": "2024-01-01T00:00:00Z",
  "created_at": "2024-01-01T00:00:00Z",
  "updated_at": "2024-01-01T00:00:00Z"
}
```

#### `GET /api/invites?orgId=uuid`

Получение списка приглашений для организации

**Ответ:**

```json
{
  "invites": [
    {
      "id": "uuid",
      "org_id": "uuid",
      "email": "user@example.com",
      "role": "MEMBER",
      "status": "PENDING",
      "token": "unique-token",
      "expires_at": "2024-01-01T00:00:00Z",
      "created_at": "2024-01-01T00:00:00Z",
      "updated_at": "2024-01-01T00:00:00Z",
      "org": {
        "id": "uuid",
        "name": "Organization Name"
      }
    }
  ]
}
```

#### `POST /api/invites/accept`

Принятие или отклонение приглашения

**Тело запроса:**

```json
{
  "token": "unique-token",
  "action": "accept" // или "decline"
}
```

#### `PATCH /api/invites/[id]`

Повторная отправка приглашения

**Тело запроса:**

```json
{
  "action": "resend"
}
```

#### `DELETE /api/invites/[id]`

Отзыв приглашения

### Frontend компоненты

#### `InviteMemberModal`

Модальное окно для создания приглашения

**Пропсы:**

- `isOpen: boolean` - открыто ли модальное окно
- `onClose: () => void` - функция закрытия
- `orgId: string` - ID организации
- `onInviteCreated: () => void` - callback после создания приглашения

#### `PendingInvites`

Список ожидающих приглашений с возможностью управления

**Пропсы:**

- `orgId: string` - ID организации
- `onInviteUpdated: () => void` - callback после обновления приглашения

#### `InviteButton`

Кнопка для открытия модала приглашения

**Пропсы:**

- `orgId: string` - ID организации
- `onInviteCreated: () => void` - callback после создания приглашения

### Публичная страница `/invite`

Страница для принятия приглашений по токену. Доступна без авторизации.

**URL параметры:**

- `token` - токен приглашения

## Безопасность

### Валидация прав доступа

- Только пользователи с ролями ADMIN или OWNER могут создавать и управлять приглашениями
- Проверка прав происходит на уровне базы данных через RLS политики

### Токены приглашений

- Уникальные токены генерируются для каждого приглашения
- Токены имеют ограниченный срок действия (7 дней по умолчанию)
- Токены могут быть отозваны администраторами

### Rate Limiting

- Рекомендуется добавить rate limiting для API создания приглашений
- Ограничение на количество приглашений в день для предотвращения спама

## Email интеграция

### Текущее состояние

В текущей реализации email отправка не реализована. Приглашения создаются в базе данных, но email не отправляется.

### Планы по интеграции

1. Настройка Supabase SMTP или внешнего SMTP сервиса
2. Создание email шаблонов для приглашений
3. Интеграция с API создания приглашений
4. Добавление возможности повторной отправки email

### Email шаблон (планируется)

```html
<h2>Приглашение в организацию</h2>
<p>Вас приглашают присоединиться к организации "{{org_name}}"</p>
<p>Роль: {{role}}</p>
<a href="{{invite_url}}">Принять приглашение</a>
```

## Использование

### Создание приглашения

1. Администратор переходит на страницу участников
2. Нажимает кнопку "Пригласить участника"
3. Заполняет email и выбирает роль
4. Нажимает "Отправить приглашение"

### Принятие приглашения

1. Пользователь получает ссылку на приглашение
2. Переходит по ссылке `/invite?token=...`
3. Нажимает "Принять приглашение"
4. Автоматически создается членство в организации

### Управление приглашениями

1. Администратор видит список ожидающих приглашений
2. Может повторить отправку или отозвать приглашение
3. Видит статус каждого приглашения

## Ограничения

### Текущие ограничения

- Email отправка не реализована
- Нет уведомлений о новых приглашениях
- Нет истории приглашений

### Планируемые улучшения

- Email интеграция
- Уведомления в реальном времени
- История приглашений
- Массовые приглашения
- Шаблоны приглашений
- Аналитика приглашений

## Troubleshooting

### Частые проблемы

#### Приглашение не создается

- Проверьте права доступа пользователя (должен быть ADMIN или OWNER)
- Проверьте валидность email
- Проверьте, не существует ли уже приглашение для этого email

#### Приглашение не принимается

- Проверьте срок действия приглашения
- Проверьте статус приглашения (должен быть PENDING)
- Проверьте, не является ли пользователь уже членом организации

#### Ошибки RLS

- Убедитесь, что RLS политики правильно настроены
- Проверьте, что пользователь является членом организации с нужными правами

## Развертывание

### База данных

1. Выполните SQL скрипт `supabase/create-invites-table.sql`
2. Проверьте, что RLS политики работают корректно
3. Протестируйте создание и принятие приглашений

### Frontend

1. Убедитесь, что все компоненты импортированы
2. Проверьте, что middleware разрешает доступ к `/invite`
3. Протестируйте UI на странице участников

### API

1. Проверьте, что все API эндпоинты работают
2. Протестируйте валидацию и обработку ошибок
3. Проверьте права доступа
