name: Preview Smoke Tests

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  smoke:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Wait for Vercel deployment
        id: vercel
        run: |
          # –ñ–¥–µ–º deployment URL –∏–∑ Vercel
          # –í —Ä–µ–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —ç—Ç–æ –±—É–¥–µ—Ç –ø–æ–ª—É—á–µ–Ω–æ —á–µ—Ä–µ–∑ Vercel API
          # –ü–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º placeholder
          echo "url=https://mvpport-git-feature-${GITHUB_HEAD_REF}-abakymuk.vercel.app" >> $GITHUB_OUTPUT
          echo "Preview URL will be available after Vercel deployment"

      - name: Test health endpoint
        run: |
          echo "Preview URL: ${{ steps.vercel.outputs.url }}"
          echo "Testing health endpoint..."
          
          # –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
          sleep 10
          
          # –¢–µ—Å—Ç–∏—Ä—É–µ–º health endpoint
          HEALTH_RESPONSE=$(curl -fsSL "${{ steps.vercel.outputs.url }}/api/health" || echo "{}")
          echo "Health response: $HEALTH_RESPONSE"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç "ok"
          if [[ "$HEALTH_RESPONSE" == *"ok"* ]]; then
            echo "‚úÖ Health endpoint is working"
          else
            echo "‚ùå Health endpoint is not working"
            exit 1
          fi

      - name: Test main page
        run: |
          echo "Testing main page..."
          
          # –¢–µ—Å—Ç–∏—Ä—É–µ–º –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
          MAIN_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${{ steps.vercel.outputs.url }}/" || echo "000")
          echo "Main page status: $MAIN_STATUS"
          
          if [[ "$MAIN_STATUS" == "200" ]]; then
            echo "‚úÖ Main page is accessible"
          else
            echo "‚ùå Main page is not accessible (status: $MAIN_STATUS)"
            exit 1
          fi

      - name: Comment PR with preview info
        uses: actions/github-script@v7
        with:
          script: |
            const previewUrl = '${{ steps.vercel.outputs.url }}';
            const prNumber = context.issue.number;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å –ø—Ä–µ–≤—å—é
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            const existingComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('üöÄ Preview Deployment')
            );
            
            const commentBody = `## üöÄ Preview Deployment
            
            **Preview URL:** [${previewUrl}](${previewUrl})
            
            ### Smoke Tests Status
            - ‚úÖ Health endpoint: Working
            - ‚úÖ Main page: Accessible
            
            ### Quick Links
            - [Preview Dashboard](${previewUrl})
            - [Health Check](${previewUrl}/api/health)
            
            ---
            *Preview automatically deployed by Vercel*
            `;
            
            if (existingComment) {
              // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: commentBody
              });
            } else {
              // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody
              });
            }
